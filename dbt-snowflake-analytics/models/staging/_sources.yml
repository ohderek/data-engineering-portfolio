version: 2

sources:
  - name: ecommerce
    description: Raw e-commerce data ingested via the ETL pipeline into the RAW layer.
    database: "{{ var('ecommerce_database') }}"
    schema: "{{ var('ecommerce_schema') }}"
    loader: airflow_etl_pipeline
    freshness:
      warn_after:  { count: 2,  period: hour }
      error_after: { count: 12, period: hour }
    loaded_at_field: _loaded_at

    tables:
      - name: orders
        description: One row per API order record as written by the ingestion pipeline.
        columns:
          - name: order_id
            tests: [not_null]
          - name: customer_id
            tests: [not_null]
          - name: status
            tests:
              - not_null
              - accepted_values:
                  values: [pending, processing, completed, cancelled, refunded]
          - name: total_amount
            tests: [not_null]
          - name: currency
            tests:
              - not_null
              - accepted_values:
                  values: [USD, EUR, GBP, CAD, AUD]
          - name: created_at
            tests: [not_null]
          - name: updated_at
            tests: [not_null]

      - name: order_items
        description: Line-item detail within each order.
        columns:
          - name: order_item_id
            tests: [not_null, unique]
          - name: order_id
            tests: [not_null]
          - name: product_id
            tests: [not_null]
          - name: quantity
            tests:
              - not_null
              - dbt_utils.accepted_range:
                  min_value: 1
          - name: unit_price
            tests: [not_null]

      - name: customers
        description: Customer master synced from the CRM.
        columns:
          - name: customer_id
            tests: [not_null, unique]
          - name: email
            tests: [not_null]
          - name: country_code
            tests: [not_null]
          - name: created_at
            tests: [not_null]

      - name: products
        description: Product catalogue snapshot updated nightly.
        columns:
          - name: product_id
            tests: [not_null, unique]
          - name: product_sku
            tests: [not_null, unique]
          - name: product_name
            tests: [not_null]
          - name: product_category
            tests: [not_null]
