version: 2

sources:
  - name: ecommerce
    description: >
      Raw e-commerce data landed from the ingestion pipeline into the RAW database.
      Tables are append-only; deduplication happens in staging models.
    database: "{{ var('ecommerce_database') }}"
    schema:   "{{ var('ecommerce_schema') }}"
    loader: airflow_etl_pipeline

    freshness:
      warn_after:  { count: 2,  period: hour }
      error_after: { count: 12, period: hour }
    loaded_at_field: _loaded_at

    tables:
      - name: orders
        description: One row per order record as received from the API.
        columns:
          - name: order_id
            description: Surrogate key from the source system.
            tests:
              - not_null
          - name: customer_id
            tests: [not_null]
          - name: status
            tests:
              - not_null
              - accepted_values:
                  values: [pending, processing, completed, cancelled, refunded]
          - name: total_amount
            tests: [not_null]
          - name: currency
            tests:
              - not_null
              - accepted_values:
                  values: [USD, EUR, GBP, CAD, AUD]
          - name: created_at
            tests: [not_null]
          - name: updated_at
            tests: [not_null]

      - name: order_items
        description: Line items within each order.
        columns:
          - name: order_item_id
            tests: [not_null, unique]
          - name: order_id
            tests: [not_null]
          - name: product_id
            tests: [not_null]
          - name: quantity
            tests:
              - not_null
              - dbt_utils.accepted_range:
                  min_value: 1
          - name: unit_price
            tests: [not_null]
          - name: discount
            tests:
              - dbt_utils.accepted_range:
                  min_value: 0
                  max_value: 1
                  inclusive: true

      - name: customers
        description: Customer master from CRM sync.
        columns:
          - name: customer_id
            tests: [not_null, unique]
          - name: email
            tests: [not_null]
          - name: country_code
            tests: [not_null]
          - name: created_at
            tests: [not_null]
